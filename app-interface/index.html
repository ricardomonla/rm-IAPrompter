<!--
  -----------------------------------------------------------------------------
  Project:     MFM Assistant - Sistema de Gesti√≥n de Interfaz
  File:        index.html
  Version:     v3.1.3 (2025-12-01 20:42)
  Author:      Lic. Ricardo MONLA
  Description: 
  -----------------------------------------------------------------------------
  Este archivo contiene la estructura HTML principal con:
  - Integraci√≥n de estilos y scripts externos
  - Estructura modular para componentes de interfaz
  - Protecci√≥n contra vulnerabilidades XSS mediante CSP
  - Marcado sem√°ntico para accesibilidad.
  -----------------------------------------------------------------------------
-->

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; connect-src 'self' http://localhost:5000; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com;">
    
    <title>MFM Assistant v3.1</title>
    
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <link rel="stylesheet" href="styles.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.1/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>
<body class="mode-expanded"> 

    <div id="app-container">
        <div id="settings-modal" class="hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>GESTI√ìN DE PLANTILLAS</h3>
                    <button id="close-settings-btn">√ó</button>
                </div>
                
                <div class="modal-body" style="display: flex; flex-direction: column; height: 100%; padding-bottom: 0;">
                    
                    <div style="background: #111; padding: 10px; border-radius: 6px; border: 1px solid #333; margin-bottom: 15px;">
                        <div style="display: flex; gap: 10px;">
                            <select id="tpl-selector" style="flex: 1; background: #08080a; color: #fff; border: 1px solid #444; padding: 8px; border-radius: 4px; outline: none; font-family: 'JetBrains Mono'; font-size: 12px;">
                                </select>
                            <button id="delete-tpl-btn" title="Eliminar Actual" style="background: #1a0505; border: 1px solid #522; color: #f44336; padding: 0 12px; border-radius: 4px; cursor: pointer; font-size: 14px;">üóë</button>
                        </div>
                    </div>

                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 5px;">
                        <span id="form-mode-label" style="font-size: 10px; font-weight: bold; color: #666; letter-spacing: 1px;">NUEVA PLANTILLA</span>
                        <button id="cancel-edit-btn" class="hidden" style="background:none; border:none; color:#888; font-size:10px; cursor:pointer; text-decoration:underline;">CANCELAR EDICI√ìN</button>
                    </div>

                    <div style="flex: 1; display: flex; flex-direction: column; gap: 10px;">
                        <input type="text" id="new-tpl-label" placeholder="Nombre de la Plantilla (Ej: SQL Fix)" style="background: #08080a; border: 1px solid #333; color: var(--accent); padding: 10px; border-radius: 4px; outline: none; font-family: inherit;">
                        
                        <textarea id="new-tpl-value" placeholder="Escribe el contenido del prompt aqu√≠..." style="flex: 1; background: #08080a; border: 1px solid #333; color: #ccc; padding: 12px; border-radius: 4px; outline: none; font-family: inherit; resize: none; line-height: 1.5;"></textarea>
                        
                        <div style="display: flex; gap: 10px;">
                            <button id="add-tpl-btn" style="flex: 2; background: #222; color: #fff; border: 1px solid #444; padding: 10px; cursor: pointer; border-radius: 4px; font-weight: bold;">GUARDAR</button>
                            <button id="clone-tpl-btn" class="hidden" style="flex: 1; background: #0d1a20; color: var(--accent); border: 1px solid #004d40; padding: 10px; cursor: pointer; border-radius: 4px; font-size: 10px;">GUARDAR COMO NUEVA</button>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button id="save-settings-btn">CERRAR Y GUARDAR</button>
                </div>
            </div>
        </div>

        <div id="content-wrapper">
            <button id="close-btn" onclick="minimizeApp()">√ó</button>
            
            <div id="login-screen" class="hidden">
                <h3 style="color:#ff9800; letter-spacing:2px; font-size:12px;">SISTEMA PROTEGIDO</h3>
                <input type="password" id="master-key-input" placeholder="CLAVE DE ACCESO">
                <button id="unlock-btn">INICIAR</button>
            </div>

            <div id="main-interface" class="hidden">
                
                <div id="left-panel">
                    <div id="active-response-area">
                        <div style="text-align:center; color:#444; margin-top:20vh;">
                            <div style="font-size:14px; margin-bottom:5px; color:var(--accent);">‚ùñ MFM CORE ONLINE</div>
                            <div style="font-size:11px;">Esperando instrucciones...</div>
                        </div>
                    </div>
                </div>

                <div id="right-panel">
                    
                    <div id="headers-section">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px;">
                            <span class="section-label">Cabeceras (Contexto)</span>
                            <div id="toolbar-container">
                                <button id="templates-list-btn" title="Lista de Plantillas">//</button>
                                <button id="prev-template-btn" title="Plantilla Anterior"><</button>
                                <button id="next-template-btn" title="Siguiente Plantilla">></button>
                                <button id="edit-template-btn" title="Editar Plantilla">‚úé</button>
                                <button id="duplicate-template-btn" title="Duplicar Plantilla">‚ùê</button>
                            </div>
                        </div>
                        <div style="position: relative; height: 100%; display: flex; flex-direction: column;">
                            <textarea id="header-input" readonly placeholder="Navega usando los botones para seleccionar una plantilla..."></textarea>
                            <div id="template-selector-menu" class="hidden"></div>
                            <div id="autocomplete-menu"></div>
                        </div>
                    </div>

                    <div id="composer-section">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span class="section-label">Prompt Inicial</span>
                            <button id="clear-btn">LIMPIAR</button>
                        </div>
                        
                        <textarea id="ai-input" placeholder="Redacta el cuerpo de tu solicitud aqu√≠..."></textarea>
                        
                        <button id="send-btn">GENERAR C√ìDIGO</button>
                    </div>

                </div>
            </div>
        </div>

        <div id="header-hex">
            <svg viewBox="0 0 100 100">
                <path class="hex-outer" d="M50 10 L85 30 L85 70 L50 90 L15 70 L15 30 Z" />
                <path class="hex-inner" d="M50 25 L72 37 L72 63 L50 75 L28 63 L28 37 Z" />
                <circle class="hex-core" cx="50" cy="50" r="12" />
            </svg>
        </div>
    </div>

    <script>
        const { ipcRenderer, clipboard } = require('electron');
        const fs = require('fs');
        const path = require('path');
        
        if (typeof marked !== 'undefined') marked.use({ breaks: true, gfm: true });

        const API_URL = 'http://localhost:5000/api';
        
        let isProcessing = false;

        const DEFAULT_TEMPLATES = [
            { label: 'Mejora de Prompt', value: 'Mejora la redacci√≥n del siguiente PROMPT teniendo en cuenta que va dirigido a una IA experta:' },
            { label: 'Generaci√≥n de C√≥digo', value: 'Act√∫a como desarrollador Senior. Genera el c√≥digo completo y funcional para:' },
            { label: 'Refactorizaci√≥n', value: 'Analiza el siguiente c√≥digo, busca errores y refactoriza aplicando mejores pr√°cticas:' },
            { label: 'Explicaci√≥n T√©cnica', value: 'Explica detalladamente el funcionamiento l√≥gico del siguiente fragmento:' }
        ];

        // --- CARGA DE DATOS ---
        let headerTemplates = [];
        
        // Funci√≥n para cargar plantillas desde la API
        async function loadTemplates() {
            try {
                const response = await fetch(`${API_URL}/get_templates`);
                const data = await response.json();
                
                if (data.success && data.templates) {
                    return data.templates;
                } else {
                    console.error("Error en respuesta de API:", data.message);
                    return [...DEFAULT_TEMPLATES];
                }
            } catch (err) {
                console.error("Error cargando templates desde API:", err);
                return [...DEFAULT_TEMPLATES];
            }
        }
        
        // Funci√≥n para guardar plantillas en la API
        async function saveTemplates(templates) {
            try {
                const response = await fetch(`${API_URL}/save_templates`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({templates})
                });
                const data = await response.json();
                return data.success;
            } catch (err) {
                console.error("Error guardando templates:", err);
                return false;
            }
        }
        
        // Las plantillas se cargar√°n despu√©s del login exitoso

        let editingIndex = -1;
        
        // Sistema de navegaci√≥n de plantillas (Nuevo)
        let currentTemplateIndex = -1;
        let isEditing = false;
        let hasUnsavedChanges = false;

        // UI REFERENCES
        const ui = {
            responseArea: document.getElementById('active-response-area'),
            headerInput: document.getElementById('header-input'),
            bodyInput: document.getElementById('ai-input'),
            autocompleteMenu: document.getElementById('autocomplete-menu'),
            sendBtn: document.getElementById('send-btn'),
            hexContainer: document.getElementById('header-hex'),
            login: document.getElementById('login-screen'),
            main: document.getElementById('main-interface'),
            
            // Nueva barra de herramientas
            templatesListBtn: document.getElementById('templates-list-btn'),
            prevTemplateBtn: document.getElementById('prev-template-btn'),
            nextTemplateBtn: document.getElementById('next-template-btn'),
            editTemplateBtn: document.getElementById('edit-template-btn'),
            duplicateTemplateBtn: document.getElementById('duplicate-template-btn'),
            templateSelectorMenu: document.getElementById('template-selector-menu'),
            
            // Modal Elements (Para compatibilidad temporal)
            modal: document.getElementById('settings-modal'),
            tplSelector: document.getElementById('tpl-selector'),
            deleteBtn: document.getElementById('delete-tpl-btn'),
            
            settingsBtn: document.getElementById('settings-trigger-btn'),
            closeSettingsBtn: document.getElementById('close-settings-btn'),
            saveSettingsBtn: document.getElementById('save-settings-btn'),
            
            addTplBtn: document.getElementById('add-tpl-btn'),
            cloneTplBtn: document.getElementById('clone-tpl-btn'),
            newLabel: document.getElementById('new-tpl-label'),
            newValue: document.getElementById('new-tpl-value'),
            
            formModeLabel: document.getElementById('form-mode-label'),
            cancelEditBtn: document.getElementById('cancel-edit-btn')
        };

        // --- NUEVO SISTEMA DE NAVEGACI√ìN DE PLANTILLAS ---
        
        // Inicializar con la primera plantilla al cargar
        async function initializeTemplates() {
            headerTemplates = await loadTemplates();
            console.log('Plantillas cargadas:', headerTemplates.length);
            if (headerTemplates.length > 0) {
                currentTemplateIndex = 0;
                loadCurrentTemplate();
                console.log('Plantilla inicial cargada:', headerTemplates[0].label);
            }
        }
        
        function loadCurrentTemplate() {
            if (currentTemplateIndex >= 0 && currentTemplateIndex < headerTemplates.length) {
                const template = headerTemplates[currentTemplateIndex];
                ui.headerInput.value = template.value;
                updateTemplateSelectorMenu();
            }
        }
        
        function updateTemplateSelectorMenu() {
            ui.templateSelectorMenu.innerHTML = '';
            
            headerTemplates.forEach((tpl, index) => {
                const div = document.createElement('div');
                div.className = 'template-menu-item';
                if (index === currentTemplateIndex) {
                    div.classList.add('current');
                }
                div.innerHTML = `
                    <strong>${tpl.label}</strong>
                    <div class="template-preview">${tpl.value.substring(0, 50)}...</div>
                `;
                div.onclick = () => selectTemplateByIndex(index);
                ui.templateSelectorMenu.appendChild(div);
            });
        }
        
        function showTemplateSelector() {
            updateTemplateSelectorMenu();
            ui.templateSelectorMenu.classList.remove('hidden');
        }
        
        function hideTemplateSelector() {
            ui.templateSelectorMenu.classList.add('hidden');
        }
        
        function selectTemplateByIndex(index) {
            if (index >= 0 && index < headerTemplates.length) {
                currentTemplateIndex = index;
                loadCurrentTemplate();
                ui.headerInput.readOnly = !isEditing;
                hideTemplateSelector();
                console.log('Plantilla seleccionada por √≠ndice:', index);
            }
        }
        
        function navigateTemplate(direction) {
            if (headerTemplates.length === 0) return;
            
            // En el nuevo sistema, no verificamos cambios sin guardar antes de navegar
            // ya que el guardado es inmediato al salir del modo edici√≥n
            
            currentTemplateIndex += direction;
            if (currentTemplateIndex < 0) currentTemplateIndex = headerTemplates.length - 1;
            if (currentTemplateIndex >= headerTemplates.length) currentTemplateIndex = 0;
            
            loadCurrentTemplate();
            ui.headerInput.readOnly = !isEditing;
            console.log('Navegando plantilla:', direction > 0 ? 'siguiente' : 'anterior');
        }
        
        function toggleEditMode() {
            if (isEditing) {
                // ESTAMOS EN MODO EDICI√ìN - GUARDAR Y SALIR
                console.log('Click en modo edici√≥n - Guardando...');
                saveCurrentTemplate().then(success => {
                    if (success) {
                        deactivateEditMode();
                        console.log('Guardado exitoso - Modo edici√≥n desactivado');
                    } else {
                        console.log('Error al guardar - Manteniendo modo edici√≥n');
                        // Mantener modo edici√≥n si falla el guardado
                    }
                });
            } else {
                // ESTAMOS EN MODO LECTURA - ACTIVAR EDICI√ìN
                console.log('Click en modo lectura - Activando edici√≥n...');
                activateEditMode();
                console.log('Modo edici√≥n activado');
            }
        }
        
        function activateEditMode() {
            isEditing = true;
            
            // Configurar textarea para edici√≥n
            ui.headerInput.readOnly = false;
            ui.headerInput.classList.add('editing-mode');
            
            // Cambiar bot√≥n de edici√≥n a guardado
            ui.editTemplateBtn.textContent = 'üíæ';
            ui.editTemplateBtn.title = 'Guardar Cambios';
            
            // DESHABILITAR ELEMENTOS QUE CAMBIAN CONTEXTO/PLANTILLA
            const contextChangeButtons = [
                ui.templatesListBtn,      // Lista de plantillas
                ui.prevTemplateBtn,        // Navegaci√≥n anterior
                ui.nextTemplateBtn,        // Navegaci√≥n siguiente
                ui.duplicateTemplateBtn    // Duplicar plantilla
            ];
            
            // Deshabilitar todos los botones de cambio de contexto
            contextChangeButtons.forEach(btn => {
                if (btn) {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                }
            });
            
            // Enfocar y seleccionar contenido
            ui.headerInput.focus();
            ui.headerInput.select();
            
            console.log('Modo edici√≥n activado - Cambios de contexto deshabilitados');
        }
        
        function deactivateEditMode() {
            isEditing = false;
            
            // Restaurar textarea a solo lectura
            ui.headerInput.readOnly = true;
            ui.headerInput.classList.remove('editing-mode');
            
            // Cambiar bot√≥n de guardado a edici√≥n
            ui.editTemplateBtn.textContent = '‚úé';
            ui.editTemplateBtn.title = 'Editar Plantilla';
            
            // REACTIVAR TODOS LOS ELEMENTOS PREVIAMENTE DESHABILITADOS
            const contextChangeButtons = [
                ui.templatesListBtn,      
                ui.prevTemplateBtn,        
                ui.nextTemplateBtn,        
                ui.duplicateTemplateBtn    
            ];
            
            contextChangeButtons.forEach(btn => {
                if (btn) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                }
            });
            

            
            console.log('Modo edici√≥n desactivado - Todos los controles reactivados');
        }
        
        function duplicateCurrentTemplate() {
            if (currentTemplateIndex >= 0 && currentTemplateIndex < headerTemplates.length) {
                const currentTemplate = headerTemplates[currentTemplateIndex];
                const newTemplate = {
                    label: currentTemplate.label + ' (Copia)',
                    value: currentTemplate.value
                };
                headerTemplates.push(newTemplate);
                currentTemplateIndex = headerTemplates.length - 1;
                loadCurrentTemplate();
                console.log('Plantilla duplicada creada');
            }
        }
        
        function updateUnsavedState(changed) {
            hasUnsavedChanges = changed;
            // Ya no hay bot√≥n de save separado, el estado se maneja por el toggle button
            console.log('Estado de cambios sin guardar:', changed);
        }
        
        async function saveCurrentTemplate() {
            if (currentTemplateIndex >= 0 && currentTemplateIndex < headerTemplates.length) {
                const newValue = ui.headerInput.value.trim();
                if (!newValue) {
                    alert('El contenido de la plantilla no puede estar vac√≠o.');
                    return false;
                }
                
                headerTemplates[currentTemplateIndex].value = newValue;
                
                const success = await saveTemplates(headerTemplates);
                if (success) {
                    console.log('Plantilla guardada exitosamente');
                    return true;
                } else {
                    alert('Error al guardar la plantilla. Intenta nuevamente.');
                    return false;
                }
            }
            return false;
        }
        
        // Event listeners para la nueva barra de herramientas
        ui.templatesListBtn.addEventListener('click', () => {
            if (!isEditing && ui.templateSelectorMenu.classList.contains('hidden')) {
                showTemplateSelector();
            } else if (!isEditing) {
                hideTemplateSelector();
            }
        });
        
        ui.prevTemplateBtn.addEventListener('click', () => {
            if (!isEditing) {
                navigateTemplate(-1);
            }
        });
        
        ui.nextTemplateBtn.addEventListener('click', () => {
            if (!isEditing) {
                navigateTemplate(1);
            }
        });
        
        // EL MISMO BOT√ìN FUNCIONA COMO EDIT/SAVE (TOGGLE)
        ui.editTemplateBtn.addEventListener('click', toggleEditMode);
        
        ui.duplicateTemplateBtn.addEventListener('click', () => {
            if (!isEditing) {
                duplicateCurrentTemplate();
            }
        });
        

        
        // Detectar cambios en el textarea (solo para feedback visual durante edici√≥n)
        ui.headerInput.addEventListener('input', () => {
            if (isEditing) {
                // Feedback visual de cambios (sin estado separate de "unsaved")
                console.log('Cambios detectados en modo edici√≥n');
            }
        });
        
        // Permitir salir del modo edici√≥n con Escape
        ui.headerInput.addEventListener('keydown', (e) => {
            if (isEditing && e.key === 'Escape') {
                toggleEditMode();
            }
        });
        
        // Cerrar men√∫s al hacer clic fuera
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#headers-section')) {
                hideTemplateSelector();
            }
        });

        // --- AUTOCOMPLETE & CORE (Actualizado) ---
        function setHexState(state) { ui.hexContainer.className = state ? `status-${state}` : ''; }

        let selectedIndex = -1;
        ui.headerInput.addEventListener('input', (e) => {
            if (e.target.value.includes('//') && !isEditing) {
                showAutocomplete();
            } else {
                hideAutocomplete();
            }
        });

        function showAutocomplete() {
            ui.autocompleteMenu.innerHTML = '';
            headerTemplates.forEach((tpl, index) => {
                const div = document.createElement('div');
                div.className = 'autocomplete-item';
                div.innerHTML = `<strong>${tpl.label}</strong><span style="opacity:0.6">${tpl.value.substring(0, 40)}...</span>`;
                div.onclick = () => selectTemplateFromAutocomplete(index);
                ui.autocompleteMenu.appendChild(div);
            });
            ui.autocompleteMenu.style.display = 'block';
        }

        function hideAutocomplete() { ui.autocompleteMenu.style.display = 'none'; selectedIndex = -1; }

        function selectTemplateFromAutocomplete(templateIndex) {
            currentTemplateIndex = templateIndex;
            loadCurrentTemplate();
            hideAutocomplete();
            ui.bodyInput.focus();
        }

        ui.headerInput.addEventListener('keydown', (e) => {
            if (ui.autocompleteMenu.style.display === 'block') {
                const items = document.querySelectorAll('.autocomplete-item');
                if (e.key === 'ArrowDown') { e.preventDefault(); selectedIndex = (selectedIndex + 1) % items.length; highlightItem(items); }
                else if (e.key === 'ArrowUp') { e.preventDefault(); selectedIndex = (selectedIndex - 1 + items.length) % items.length; highlightItem(items); }
                else if (e.key === 'Enter') { e.preventDefault(); if (selectedIndex >= 0) selectTemplateFromAutocomplete(selectedIndex); }
                else if (e.key === 'Escape') hideAutocomplete();
            }
        });

        function highlightItem(items) {
            items.forEach(i => i.classList.remove('selected'));
            if(items[selectedIndex]) items[selectedIndex].classList.add('selected');
        }

        async function sendAI() {
            if (isProcessing) return;
            const fullQuery = (ui.headerInput.value.trim() ? ui.headerInput.value.trim() + "\n\n" : "") + ui.bodyInput.value.trim();
            if (!fullQuery.trim()) return;

            isProcessing = true;
            setHexState('thinking');
            ui.responseArea.innerHTML = `<div style="text-align:center; opacity:0.7; margin-top:50px; color:var(--accent);">PROCESANDO...</div>`;

            try {
                const res = await fetch(`${API_URL}/query_gemini`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({query: fullQuery})
                });
                const data = await res.json();
                if (data.response) { renderResponse(data.response); setHexState('success'); }
                else { renderError(data.error); setHexState('error'); }
            } catch (e) { renderError("Error de conexi√≥n."); setHexState('error'); }

            isProcessing = false;
            setTimeout(() => setHexState(''), 3000);
        }

        function renderResponse(txt) {
            ui.responseArea.innerHTML = `<div class="response-content">${marked.parse(txt)}</div>`;
            ui.responseArea.querySelectorAll('pre code').forEach((block) => hljs.highlightElement(block));
            addCopyButtons();
        }

        function addCopyButtons() {
            ui.responseArea.querySelectorAll('pre').forEach((preBlock) => {
                if(preBlock.querySelector('button')) return;
                const btn = document.createElement('button');
                btn.textContent = 'COPIAR';
                btn.style.cssText = "position:absolute; top:10px; right:10px; background:#222; color:var(--accent); border:1px solid #444; padding:4px 8px; font-size:9px; cursor:pointer; border-radius:3px; opacity:0.8;";
                preBlock.style.position = 'relative';
                btn.addEventListener('click', () => {
                    clipboard.writeText(preBlock.querySelector('code').innerText);
                    btn.textContent = 'COPIADO'; setTimeout(()=> btn.textContent='COPIAR', 2000);
                });
                preBlock.appendChild(btn);
            });
        }

        function renderError(msg) { ui.responseArea.innerHTML = `<div style="color:#f44336; padding:20px;">ERROR: ${msg}</div>`; }

        ui.sendBtn.addEventListener('click', sendAI);
        ui.bodyInput.addEventListener('keydown', (e) => { if (e.ctrlKey && e.key === 'Enter') sendAI(); });
        document.getElementById('clear-btn').addEventListener('click', () => { ui.headerInput.value = ''; ui.bodyInput.value = ''; });

        window.minimizeApp = function() { ipcRenderer.send('resize-window', 'mini'); }
        
        ui.hexContainer.addEventListener('click', () => {
            const isMini = document.body.classList.contains('mode-mini');
            // FIX CR√çTICO: Asegura que el estado se env√≠e correctamente al Main
            ipcRenderer.send('resize-window', isMini ? 'expanded' : 'mini');
        });
        
        ipcRenderer.on('force-mode-update', (e, mode) => {
            document.body.className = `mode-${mode}`;
        });

        // LOCK SYSTEM
        const attemptUnlock = async () => {
            const key = document.getElementById('master-key-input').value;
            setHexState('thinking');
            try {
                const res = await fetch(`${API_URL}/initialize`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({master_key: key}) });
                const d = await res.json();
                if(d.success) { 
                    ui.login.classList.add('hidden'); 
                    ui.main.classList.remove('hidden'); 
                    setHexState('success');
                    // Inicializar plantillas despu√©s del login exitoso
                    await initializeTemplates();
                }
                else { setHexState('error'); }
            } catch(e) { setHexState('error'); }
        };

        (async () => {
            try {
                const res = await fetch(`${API_URL}/is_initialized`);
                const data = await res.json();
                if(data.initialized) { 
                    ui.login.classList.add('hidden'); 
                    ui.main.classList.remove('hidden');
                    // Inicializar plantillas si ya est√° autenticado
                    await initializeTemplates();
                }
                else ui.login.classList.remove('hidden');
            } catch(e) {}
        })();
        
        document.getElementById('unlock-btn').addEventListener('click', attemptUnlock);
        document.getElementById('master-key-input').addEventListener('keypress', (e) => e.key === 'Enter' && attemptUnlock());
    </script>
</body>
</html>