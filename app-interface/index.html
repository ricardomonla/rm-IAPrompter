<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; connect-src 'self' http://localhost:5000; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com;">
    
    <title>MFM Assistant v2.2</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">

    <style>
        /* --- ESTRUCTURA BASE --- */
        :root { --chat-base-size: 13px; --accent: #00bcd4; --bg-dark: rgba(12, 14, 18, 0.98); --border: #333; }

        body { margin: 0; padding: 0; background: transparent; color: #e0e0e0; font-family: 'JetBrains Mono', monospace; overflow: hidden; height: 100vh; width: 100%; }
        
        #app-container {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--bg-dark); 
            border: 1px solid var(--border); border-radius: 12px; 
            display: flex; flex-direction: column; overflow: hidden; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.7); backdrop-filter: blur(12px);
        }
        
        body.mode-mini #app-container { background: transparent; border: none; box-shadow: none; backdrop-filter: none; }
        body.mode-mini #content-wrapper { display: none; }
        
        /* --- HEADER & HEXAGONO --- */
        #header-hex {
            position: absolute; bottom: 10px; right: 10px;
            width: 60px; height: 60px; z-index: 200; -webkit-app-region: no-drag; cursor: pointer; transition: transform 0.3s;
        }
        #header-hex:hover { transform: scale(1.1); }
        #close-btn { position: absolute; top: 10px; right: 15px; background: none; border: none; color: #666; cursor: pointer; font-size: 18px; z-index: 101; }
        #close-btn:hover { color: #f44336; }

        /* --- LAYOUT PRINCIPAL (2 COLUMNAS) --- */
        #content-wrapper { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; z-index: 50; }
        #login-screen { flex: 1; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        
        #main-interface { flex: 1; display: flex; flex-direction: row; overflow: hidden; height: 100%; }

        /* --- COLUMNA IZQUIERDA: VISOR (LECTURA) 65% --- */
        #left-panel {
            flex: 2; /* Ocupa más espacio */
            display: flex; flex-direction: column;
            border-right: 1px solid var(--border);
            position: relative; min-width: 0; background: rgba(0,0,0,0.2);
        }

        #active-response-area {
            flex: 1; overflow-y: auto; padding: 30px 40px;
            font-size: var(--chat-base-size); line-height: 1.6; color: #ccc;
        }

        /* --- COLUMNA DERECHA: CONTROL (HISTORIAL + EDITOR) 35% --- */
        #right-panel {
            flex: 1; min-width: 320px; max-width: 450px;
            display: flex; flex-direction: column;
            background: rgba(20, 20, 25, 0.4);
        }

        /* SECCIÓN 1: HISTORIAL (ARRIBA) */
        #history-section {
            flex: 1; /* Toma el espacio sobrante */
            display: flex; flex-direction: column;
            overflow: hidden; border-bottom: 1px solid var(--border);
        }
        #history-header {
            padding: 12px 15px; border-bottom: 1px solid #2a2a2a;
            font-size: 10px; color: #666; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;
            display: flex; justify-content: space-between; background: rgba(0,0,0,0.2);
        }
        #history-list { flex: 1; overflow-y: auto; padding: 10px; }

        .history-item {
            padding: 10px; margin-bottom: 6px;
            background: rgba(255,255,255,0.03); border: 1px solid transparent; border-radius: 6px;
            cursor: pointer; transition: all 0.2s;
        }
        .history-item:hover { background: rgba(255,255,255,0.07); }
        .history-item.active { border-color: var(--accent); background: rgba(0, 188, 212, 0.05); }
        .hist-query { font-size: 11px; color: #ddd; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .hist-time { font-size: 9px; color: #555; margin-top: 4px; text-align: right; }

        /* SECCIÓN 2: EDITOR (ABAJO) */
        #composer-section {
            height: 35%; /* Altura fija porcentual para el editor */
            min-height: 200px;
            display: flex; flex-direction: column;
            padding: 15px;
            background: rgba(15, 17, 22, 0.95);
            box-shadow: 0 -5px 20px rgba(0,0,0,0.3);
        }
        
        .composer-header { display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center;}
        .composer-label { font-size: 10px; color: var(--accent); font-weight: bold; text-transform: uppercase; }
        .composer-hint { font-size: 9px; color: #555; }

        textarea {
            flex: 1; background: #08080a; border: 1px solid #333;
            color: #eee; padding: 12px; border-radius: 6px;
            font-size: 12px; outline: none; font-family: 'JetBrains Mono';
            resize: none; margin-bottom: 10px; line-height: 1.5;
        }
        textarea:focus { border-color: var(--accent); background: #0a0a0c; box-shadow: 0 0 8px rgba(0, 188, 212, 0.3); }

        #send-btn {
            background: #222; color: white; border: 1px solid #333; border-radius: 4px; 
            cursor: pointer; padding: 8px 0; font-weight: bold; font-size: 11px;
            transition: all 0.2s; width: 100%;
        }
        #send-btn:hover { border-color: var(--accent); color: var(--accent); background: #151515; }

        /* MARKDOWN STYLES */
        .response-content h1, .response-content h2 { color: #fff; margin-top: 25px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .response-content p { margin-bottom: 12px; }
        .response-content code { background: #222; padding: 2px 6px; border-radius: 4px; color: #e06c75; font-size: 0.9em; }
        .response-content pre { background: #18181b; padding: 15px; border-radius: 6px; overflow-x: auto; border: 1px solid #2a2a2a; margin: 15px 0; }
        
        /* SVG HEXAGONO */
        svg { overflow: visible; width: 100%; height: 100%; }
        .hex-outer { fill: none; stroke: #444; stroke-width: 2; transform-origin: 50px 50px; animation: spin 20s linear infinite; }
        .hex-inner { fill: none; stroke: #333; stroke-width: 1; }
        .hex-core { fill: #2a2a2a; transform-origin: 50px 50px; transition: fill 0.3s, filter 0.3s; }
        #header-hex:hover .hex-outer { stroke: var(--accent); stroke-width: 2.5; }
        .status-thinking .hex-core { fill: var(--accent); filter: drop-shadow(0 0 8px var(--accent)); animation: pulse 0.8s infinite alternate; }
        .status-thinking .hex-outer { stroke: var(--accent); animation: spin 2s linear infinite; }
        .status-success .hex-core { fill: #4caf50; }
        .status-error .hex-core { fill: #f44336; }
        
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0% { transform: scale(0.9); opacity: 0.7; } 100% { transform: scale(1.1); opacity: 1; } }

        .hidden { display: none !important; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        #master-key-input { width: 200px; padding: 10px; margin-bottom: 10px; text-align: center; border: 1px solid #444; background: #000; color: #fff; border-radius: 4px; }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.1/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>
<body class="mode-expanded"> 

    <div id="app-container">
        <div id="content-wrapper">
            <button id="close-btn" onclick="minimizeApp()">×</button>
            
            <div id="login-screen" class="hidden">
                <h3 style="color:#ff9800; letter-spacing:2px; font-size:12px;">SISTEMA PROTEGIDO</h3>
                <input type="password" id="master-key-input" placeholder="CLAVE DE ACCESO">
                <button id="unlock-btn" style="background:#222; color:#fff; border:1px solid #333; padding:5px 15px; margin-top:5px; cursor:pointer;">INICIAR</button>
            </div>

            <div id="main-interface" class="hidden">
                
                <div id="left-panel">
                    <div id="active-response-area">
                        <div style="text-align:center; color:#444; margin-top:150px;">
                            <div style="font-size:14px; margin-bottom:5px;">❖ MFM CORE ONLINE</div>
                            <div style="font-size:11px;">Redacta tu consulta en el panel derecho →</div>
                        </div>
                    </div>
                </div>

                <div id="right-panel">
                    
                    <div id="history-section">
                        <div id="history-header">
                            <span>Historial</span>
                            <span id="new-chat-btn" style="cursor:pointer; color:var(--accent);">[+ NUEVO]</span>
                        </div>
                        <div id="history-list"></div>
                    </div>

                    <div id="composer-section">
                        <div class="composer-header">
                            <span class="composer-label">Editor</span>
                            <span class="composer-hint">Enter: Enviar | Shift+Enter: Salto</span>
                        </div>
                        <textarea id="ai-input" placeholder="Escribe tu consulta aquí..."></textarea>
                        <button id="send-btn">ENVIAR CONSULTA</button>
                    </div>

                </div>
            </div>
        </div>

        <div id="header-hex">
            <svg viewBox="0 0 100 100">
                <path class="hex-outer" d="M50 10 L85 30 L85 70 L50 90 L15 70 L15 30 Z" />
                <path class="hex-inner" d="M50 25 L72 37 L72 63 L50 75 L28 63 L28 37 Z" />
                <circle class="hex-core" cx="50" cy="50" r="12" />
            </svg>
        </div>
    </div>

    <script>
        const { ipcRenderer, clipboard } = require('electron');
        if (typeof marked !== 'undefined') marked.use({ breaks: true, gfm: true });

        // ESTADO
        let chatSession = [];
        let activeIndex = -1;
        const SESSION_KEY = 'mfm_chat_session_v2';
        const API_URL = 'http://localhost:5000/api';
        let isProcessing = false;

        // DOM UI
        const ui = {
            login: document.getElementById('login-screen'),
            main: document.getElementById('main-interface'),
            responseArea: document.getElementById('active-response-area'),
            historyList: document.getElementById('history-list'),
            input: document.getElementById('ai-input'),
            hexContainer: document.getElementById('header-hex'),
            sendBtn: document.getElementById('send-btn')
        };

        // --- FUNCIONES CORE ---
        function setHexState(state) {
            ui.hexContainer.className = state ? `status-${state}` : '';
        }

        function loadSession() {
            const saved = localStorage.getItem(SESSION_KEY);
            if (saved) {
                try {
                    chatSession = JSON.parse(saved);
                    renderHistoryList();
                    if (chatSession.length > 0) selectItem(chatSession.length - 1);
                } catch(e) { console.error(e); }
            }
        }
        function saveSession() { localStorage.setItem(SESSION_KEY, JSON.stringify(chatSession)); }

        // RENDER HISTORIAL
        function renderHistoryList() {
            ui.historyList.innerHTML = '';
            chatSession.forEach((entry, index) => {
                const div = document.createElement('div');
                div.className = `history-item ${index === activeIndex ? 'active' : ''}`;
                div.onclick = () => selectItem(index);
                
                const queryText = entry.query.length > 40 ? entry.query.substring(0, 40) + "..." : entry.query;
                div.innerHTML = `
                    <div class="hist-query">${queryText.replace(/</g, "&lt;")}</div>
                    <div class="hist-time">${entry.timestamp || ''}</div>
                `;
                ui.historyList.prepend(div);
            });
        }

        // SELECCIONAR ITEM
        function selectItem(index) {
            if (index < 0 || index >= chatSession.length) return;
            activeIndex = index;
            renderHistoryList();
            
            const entry = chatSession[index];
            
            // Render contenido en Panel Izquierdo
            let html = `<div style="margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:10px;">
                            <strong style="color:#666; font-size:10px;">TU CONSULTA:</strong>
                            <div style="color:#ddd; margin-top:5px; white-space:pre-wrap;">${entry.query.replace(/</g, "&lt;")}</div>
                        </div>`;
            
            html += `<div class="response-content">`;
            if (entry.response) {
                html += marked.parse(entry.response);
            } else if (entry.error) {
                html += `<div style="color:#f44336">Error: ${entry.error}</div>`;
            } else {
                html += `<div style="color:var(--accent); font-style:italic;">... Generando respuesta ...</div>`;
            }
            html += `</div>`;

            ui.responseArea.innerHTML = html;
            
            // Syntax Highlighting
            ui.responseArea.querySelectorAll('pre code').forEach((block) => hljs.highlightElement(block));
            // Botones de copiar
            ui.responseArea.querySelectorAll('pre').forEach((preBlock) => {
                if(preBlock.querySelector('button')) return;
                const btn = document.createElement('button');
                btn.textContent = 'Copiar';
                btn.style.cssText = "position:absolute; top:5px; right:5px; background:#333; color:#aaa; border:none; padding:3px 8px; font-size:10px; cursor:pointer; border-radius:3px;";
                btn.addEventListener('click', () => {
                    clipboard.writeText(preBlock.querySelector('code').innerText);
                    btn.textContent = '¡Hecho!'; setTimeout(()=>btn.textContent='Copiar', 2000);
                });
                preBlock.appendChild(btn);
            });
        }

        // ENVIAR
        async function sendAI() {
            const query = ui.input.value.trim();
            if (!query || isProcessing) return;

            isProcessing = true;
            ui.input.value = ''; // Limpiar editor
            setHexState('thinking');

            const now = new Date();
            const timestamp = `${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;

            const newEntry = { query: query, response: null, timestamp: timestamp };
            chatSession.push(newEntry);
            saveSession();

            const newIndex = chatSession.length - 1;
            selectItem(newIndex);
            
            // Scroll top en respuesta
            ui.responseArea.scrollTop = 0;

            try {
                const res = await fetch(`${API_URL}/query_gemini`, {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({query: query})
                });
                const data = await res.json();
                chatSession[newIndex].response = data.response || "Sin respuesta";
                if(data.error) chatSession[newIndex].error = data.error;
                setHexState('success');
            } catch (e) {
                chatSession[newIndex].error = "Error de conexión.";
                setHexState('error');
            }

            saveSession();
            selectItem(newIndex);
            isProcessing = false;
            setTimeout(() => setHexState(''), 2500);
        }

        // EVENTOS
        // Manejo inteligente del Textarea: Enter envía, Shift+Enter salta
        ui.input.addEventListener('keydown', (e) => {
            if(e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // Evitar salto de línea
                sendAI();
            }
        });

        ui.sendBtn.addEventListener('click', sendAI);
        
        document.getElementById('new-chat-btn').addEventListener('click', () => {
            activeIndex = -1;
            renderHistoryList();
            ui.responseArea.innerHTML = `<div style="text-align:center; color:#444; margin-top:150px;">
                                            <div>❖ NUEVA CONSULTA</div>
                                            <div style="font-size:11px;">Escribe en el editor de la derecha</div>
                                         </div>`;
            ui.input.focus();
        });

        // Minimizador / Toggle
        let isMini = false;
        window.minimizeApp = function() { ipcRenderer.send('resize-window', 'mini'); }
        
        ui.hexContainer.addEventListener('click', () => {
            const targetMode = isMini ? 'expanded' : 'mini';
            ipcRenderer.send('resize-window', targetMode);
            isMini = !isMini;
        });
        
        ipcRenderer.on('force-mode-update', (e, mode) => {
            document.body.className = `mode-${mode}`;
            isMini = (mode === 'mini');
        });

        // Seguridad
        const attemptUnlock = async () => {
            const key = document.getElementById('master-key-input').value;
            setHexState('thinking');
            try {
                const res = await fetch(`${API_URL}/initialize`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({master_key: key}) });
                const d = await res.json();
                if(d.success) unlockUI(); else { setHexState('error'); setTimeout(() => setHexState('locked'), 1000); }
            } catch(e) { setHexState('error'); }
        };
        function unlockUI() {
            ui.login.classList.add('hidden');
            ui.main.classList.remove('hidden');
            setHexState('success');
            loadSession();
        }
        async function checkInit() {
            try {
                const res = await fetch(`${API_URL}/is_initialized`);
                const data = await res.json();
                if(data.initialized) unlockUI(); else { ui.login.classList.remove('hidden'); setHexState('locked'); }
            } catch(e) { setHexState('error'); }
        }

        document.getElementById('unlock-btn').addEventListener('click', attemptUnlock);
        document.getElementById('master-key-input').addEventListener('keypress', (e) => e.key === 'Enter' && attemptUnlock());

        checkInit();
    </script>
</body>
</html>