<!--
  -----------------------------------------------------------------------------
  Autor: Lic. Ricardo MONLA
  Versión: v0.9.6 (No-Clip Hexagon)
  Descripción: Hexágono con márgenes de seguridad y tamaño unificado (60px).
  -----------------------------------------------------------------------------
-->
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; connect-src 'self' http://localhost:5000; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com;">
    <title>MFM Assistant</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- ESTRUCTURA --- */
        body { margin: 0; padding: 0; background: transparent; color: #e0e0e0; font-family: 'JetBrains Mono', monospace; overflow: hidden; height: 100vh; width: 100%; position: relative; }
        
        /* Contenedor Principal */
        #app-container {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(15, 17, 22, 0.96); 
            border: 1px solid #333; 
            border-radius: 12px; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.6); 
            backdrop-filter: blur(10px);
            transition: background-color 0.2s;
        }
        
        /* --- MODO MINI --- */
        body.mode-mini #app-container { background: transparent; border: none; box-shadow: none; backdrop-filter: none; }
        body.mode-mini #content-wrapper { display: none; }
        body.mode-mini #close-btn { display: none; }
        
        /* --- HEADER (HEXÁGONO) --- */
        #header {
            position: absolute;
            /* MARGEN DE SEGURIDAD: Evita que el brillo se corte por el borde de la ventana */
            bottom: 10px; 
            right: 10px;
            
            width: 60px; /* Tamaño UNIFICADO para todos los modos */
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100; 
            -webkit-app-region: drag;
        }

        #hex-container {
            width: 60px; /* Tamaño base del hexágono */
            height: 60px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; position: relative;
            -webkit-app-region: no-drag;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            
            /* Sombra suave permanente */
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5));
        }
        #hex-container:hover { transform: scale(1.1); }

        /* --- CONTENIDO PRINCIPAL --- */
        #content-wrapper {
            position: absolute;
            top: 0; left: 0; right: 0; 
            bottom: 0; /* Ocupa todo */
            display: flex;
            flex-direction: column;
            padding: 0;
            z-index: 50;
        }

        #close-btn { 
            position: absolute; top: 10px; right: 10px; 
            background: none; border: none; color: #666; 
            cursor: pointer; font-size: 16px; z-index: 101; 
            -webkit-app-region: no-drag;
        }
        #close-btn:hover { color: #fff; }

        /* --- PANTALLAS INTERNAS --- */
        #login-screen { flex: 1; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        #main-interface { flex: 1; display: flex; flex-direction: column; overflow: hidden; height: 100%; }
        
        /* Historial */
        #history { 
            flex: 1; 
            overflow-y: auto; 
            padding: 15px 20px; 
            font-size: 12px; line-height: 1.6; color: #ccc;
            /* Espacio inferior para no chocar con el input */
            margin-bottom: 80px; 
        }
        .chat-entry { margin-bottom: 10px; border-bottom: 1px solid #2a2a2a; padding-bottom: 8px; }
        .user-query { color: #666; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
        .ai-response code { background: #111; padding: 2px 5px; border-radius: 4px; color: #a5d6ff; }

        /* --- SECCIÓN DE INPUT (BARRA LATERAL) --- */
        #input-section { 
            position: absolute;
            bottom: 10px; 
            left: 10px;
            /* Calcula el ancho restante: Total - MargenIzq - EspacioHexagono - MargenDer */
            right: 80px; /* 10px margen + 60px hex + 10px espacio */
            
            background-color: rgba(10, 10, 12, 0.8); 
            border: 1px solid #333;
            border-radius: 8px; 
            padding: 8px; 
            
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: auto;
            min-height: 60px; /* Alineado con la altura del hexágono */
        }

        /* Tabs e Inputs */
        #mode-tabs { display: flex; gap: 10px; margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 4px; }
        .tab-btn { background: none; border: none; color: #555; font-size: 10px; cursor: pointer; font-weight: bold; padding: 0; transition: color 0.2s; }
        .tab-btn.active { color: #fff; border-bottom: 2px solid #00bcd4; }
        .tab-btn.active.monitor-mode { border-bottom-color: #e91e63; }
        
        #input-area { display: flex; gap: 8px; }
        .mode-container { display: none; width: 100%; gap: 8px; }
        .mode-container.active { display: flex; }
        
        input { flex: 1; background: #050505; border: 1px solid #333; color: white; padding: 8px; border-radius: 4px; font-size: 12px; outline: none; }
        input:focus { border-color: #00bcd4; }
        button.action-btn { background: #222; color: white; border: 1px solid #333; border-radius: 4px; cursor: pointer; font-size: 10px; padding: 0 12px; font-weight: bold;}
        .btn-primary:hover { border-color: #00bcd4; color: #00bcd4; }

        /* --- SVG STYLES --- */
        svg { overflow: visible; width: 100%; height: 100%; }
        .hex-outer { fill: none; stroke: #444; stroke-width: 2; transform-origin: 50px 50px; animation: spin 20s linear infinite; transition: stroke 0.3s; }
        .hex-inner { fill: none; stroke: #333; stroke-width: 1; opacity: 0.7; }
        .hex-core { fill: #2a2a2a; transform-origin: 50px 50px; transition: fill 0.3s, filter 0.3s; }
        
        #hex-container:hover .hex-outer { stroke: #00bcd4; stroke-width: 2.5; }

        .status-thinking .hex-core { fill: #00bcd4; filter: drop-shadow(0 0 8px #00bcd4); animation: pulse 0.8s infinite alternate; }
        .status-thinking .hex-outer { stroke: #00bcd4; animation: spin 2s linear infinite; }
        .status-success .hex-core { fill: #4caf50; filter: drop-shadow(0 0 8px #4caf50); }
        .status-success .hex-outer { stroke: #4caf50; }
        .status-error .hex-core { fill: #f44336; filter: drop-shadow(0 0 8px #f44336); }
        .status-error .hex-outer { stroke: #f44336; }
        .status-locked .hex-core { fill: #ff9800; filter: drop-shadow(0 0 5px #ff9800); }
        .status-locked .hex-outer { stroke: #ff9800; animation: spin 60s linear infinite; }
        
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0% { transform: scale(0.9); opacity: 0.7; } 100% { transform: scale(1.1); opacity: 1; } }

        /* Login Styles */
        #master-key-input { width: 70% !important; margin-bottom: 10px; text-align: center; }
        #unlock-btn { width: 70% !important; padding: 10px; }
        ::-webkit-scrollbar { width: 4px; } ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
    </style>
</head>
<body class="mode-compact"> 

    <div id="app-container">
        <!-- 1. AREA DE CONTENIDO (Arriba) -->
        <div id="content-wrapper">
            <button id="close-btn" onclick="minimizeApp()">×</button>
            
            <!-- Login -->
            <div id="login-screen" style="display:none;">
                <h3 style="color:#ff9800; margin:0 0 15px 0; font-size:12px; letter-spacing:2px;">SISTEMA PROTEGIDO</h3>
                <input type="password" id="master-key-input" placeholder="CLAVE DE ACCESO">
                <button id="unlock-btn" class="action-btn">INICIAR SISTEMA</button>
                <div id="login-msg" style="color:#f44336; margin-top:10px; font-size:10px; height:12px;"></div>
            </div>

            <!-- Interfaz Principal -->
            <div id="main-interface" style="display:none;">
                <div id="history">
                    <div class="chat-entry" style="text-align:center; color:#444; margin-top:30px;">
                        <div>❖ MFM CORE ONLINE</div>
                        <div style="font-size:10px;">v0.9.6 Ready</div>
                    </div>
                </div>

                <!-- BARRA FLOTANTE DE INPUT (Abajo Izquierda) -->
                <div id="input-section">
                    <div id="mode-tabs">
                        <button class="tab-btn active" id="tab-chat" onclick="switchTab('chat')">IA CHAT</button>
                        <button class="tab-btn" id="tab-monitor" onclick="switchTab('monitor')">MONITOR</button>
                    </div>
                    <div id="input-area">
                        <div id="chat-container" class="mode-container active">
                            <input type="text" id="ai-input" placeholder="Consulta..." />
                            <button id="send-ai-btn" class="action-btn btn-primary">Enviar</button>
                        </div>
                        <div id="monitor-container" class="mode-container">
                            <input type="text" id="process-input" placeholder="Proceso..." />
                            <button id="check-process-btn" class="action-btn btn-monitor">Verificar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. HEXÁGONO (Fijo Abajo Derecha) -->
        <div id="header">
            <div id="hex-container"> 
                <svg viewBox="0 0 100 100">
                    <path class="hex-outer" d="M50 10 L85 30 L85 70 L50 90 L15 70 L15 30 Z" />
                    <path class="hex-inner" d="M50 25 L72 37 L72 63 L50 75 L28 63 L28 37 Z" />
                    <circle class="hex-core" cx="50" cy="50" r="12" />
                </svg>
            </div>
        </div>
    </div>

    <!-- SCRIPT (Sin cambios lógicos, solo estructura) -->
    <script>
        window.addEventListener('load', () => {
            const { ipcRenderer } = require('electron');
            let currentViewMode = 1; 
            let isTransitioning = false;
            let isLocked = true; 

            function setViewMode(mode) {
                currentViewMode = mode;
                const body = document.body;
                body.className = ''; 
                let modeString = (mode === 0) ? 'mini' : (mode === 1 ? 'compact' : 'expanded');
                body.classList.add(`mode-${modeString}`);
                ipcRenderer.send('resize-window', modeString);
            }

            window.cycleViewMode = function() {
                if(isTransitioning || isLocked) return; 
                let nextMode = (currentViewMode + 1) % 3;
                setViewMode(nextMode);
            }
            window.minimizeApp = function() { setViewMode(0); }

            ipcRenderer.on('force-mode-update', (e, m) => {
                document.body.className = `mode-${m}`;
                currentViewMode = (m === 'mini' ? 0 : 1);
            });
            ipcRenderer.on('current-mode-reply', (e, { mode }) => {
                document.body.className = `mode-${mode}`;
                currentViewMode = (mode === 'mini' ? 0 : 1); 
            });

            const API_URL = 'http://localhost:5000/api';
            const hexContainer = document.getElementById('hex-container');
            const masterKeyInput = document.getElementById('master-key-input'); 
            const unlockBtn = document.getElementById('unlock-btn'); 
            
            hexContainer.addEventListener('click', window.cycleViewMode);
            function setCoreState(state) { hexContainer.className = state ? `status-${state}` : ''; }

            async function checkInit() {
                try {
                    const res = await fetch(`${API_URL}/is_initialized`);
                    const data = await res.json();
                    if(data.initialized) unlockUI(false); else lockUI();
                } catch(e) { lockUI("Backend Offline"); setCoreState('error'); }
            }

            function lockUI(msg) {
                isLocked = true;
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('main-interface').style.display = 'none';
                if(msg) document.getElementById('login-msg').textContent = msg;
                setCoreState('locked');
                if(currentViewMode === 0) setViewMode(1);
            }

            function unlockUI(shouldTransition = true) {
                isLocked = false;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-interface').style.display = 'flex';
                setCoreState('success');
                if (shouldTransition) {
                    isTransitioning = true; 
                    setTimeout(() => { setCoreState(''); setViewMode(0); setTimeout(() => isTransitioning = false, 500); }, 1500); 
                } else { isTransitioning = false; setCoreState(''); }
            }

            const attemptUnlock = async () => {
                if(isTransitioning) return;
                const key = masterKeyInput.value;
                setCoreState('thinking');
                try {
                    const res = await fetch(`${API_URL}/initialize`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({master_key: key}) });
                    const d = await res.json();
                    if(d.success) unlockUI(); else { 
                        setCoreState('error'); document.getElementById('login-msg').textContent = "CLAVE INVÁLIDA"; setTimeout(() => setCoreState('locked'), 2000);
                    }
                } catch(e) { setCoreState('error'); }
            };
            masterKeyInput.addEventListener('keypress', (e) => e.key === 'Enter' && attemptUnlock());
            unlockBtn.addEventListener('click', attemptUnlock);

            window.switchTab = function(tab) {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active', 'monitor-mode'));
                document.querySelectorAll('.mode-container').forEach(c => c.classList.remove('active'));
                if(tab === 'chat') { 
                    document.getElementById('tab-chat').classList.add('active'); 
                    document.getElementById('chat-container').classList.add('active'); 
                    document.getElementById('ai-input').focus(); 
                } else { 
                    document.getElementById('tab-monitor').classList.add('active', 'monitor-mode'); 
                    document.getElementById('monitor-container').classList.add('active'); 
                    document.getElementById('process-input').focus(); 
                }
            }
            
            const sendAI = async () => {
                const q = document.getElementById('ai-input').value; if(!q) return;
                const h = document.getElementById('history');
                const userDiv = document.createElement('div'); userDiv.className = 'chat-entry'; userDiv.innerHTML = `<div class="user-query">USER > ${q}</div><div class="ai-response">...</div>`;
                h.appendChild(userDiv); h.scrollTop = h.scrollHeight; document.getElementById('ai-input').value = ''; setCoreState('thinking');
                try {
                    const r = await fetch(`${API_URL}/query_gemini`, {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({query: q})});
                    const d = await r.json();
                    userDiv.querySelector('.ai-response').textContent = d.response || d.error;
                    setCoreState(d.error ? 'error' : 'success');
                } catch(e) { setCoreState('error'); userDiv.querySelector('.ai-response').textContent = "Error de conexión"; }
            };
            document.getElementById('send-ai-btn').addEventListener('click', sendAI);
            document.getElementById('ai-input').addEventListener('keypress', (e) => e.key === 'Enter' && sendAI());

            const checkProc = async () => {
                const n = document.getElementById('process-input').value; if(!n) return;
                setCoreState('thinking');
                try {
                    const r = await fetch(`${API_URL}/check_process?process_name=${encodeURIComponent(n)}`);
                    const d = await r.json();
                    const h = document.getElementById('history');
                    const div = document.createElement('div'); div.className = 'chat-entry'; const color = d.is_running ? '#4caf50' : '#f44336';
                    div.innerHTML = `<div class="user-query">SYS CHECK > ${n}</div><div class="ai-response" style="color:${color}">${d.message}</div>`;
                    h.appendChild(div); h.scrollTop = h.scrollHeight; setCoreState(d.is_running ? 'success' : 'error');
                } catch(e) { setCoreState('error'); }
            }
            document.getElementById('check-process-btn').addEventListener('click', checkProc);
            document.getElementById('process-input').addEventListener('keypress', (e) => e.key === 'Enter' && checkProc());

            ipcRenderer.send('get-current-mode'); checkInit();
        });
    </script>
</body>
</html>