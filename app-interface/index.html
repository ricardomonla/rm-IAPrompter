<!--
  -----------------------------------------------------------------------------
  Project:     rm-Prompter
  File:        app-interface/index.html
  Version:     v3.1.4
  Date:        2025-12-04
  Author:      Lic. Ricardo MONLA
  Email:       rmonla@gmail.com
  Description: Estructura HTML principal de la interfaz de usuario.
  -----------------------------------------------------------------------------
 -->

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; connect-src 'self' http://localhost:5000; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com;">
    
    <title>rm-IAPromper - AI Prompt Generator</title>
    
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <link rel="stylesheet" href="styles.css">
    <script src="../app-version.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.1/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>
<body class="mode-expanded"> 

    <div id="app-container">
        <div id="settings-modal" class="hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>GESTI√ìN DE PLANTILLAS</h3>
                    <button id="close-settings-btn">√ó</button>
                </div>
                
                <div class="modal-body" style="display: flex; flex-direction: column; height: 100%; padding-bottom: 0;">
                    
                    <div style="background: #111; padding: 10px; border-radius: 6px; border: 1px solid #333; margin-bottom: 15px;">
                        <div style="display: flex; gap: 10px;">
                            <select id="tpl-selector" style="flex: 1; background: #08080a; color: #fff; border: 1px solid #444; padding: 8px; border-radius: 4px; outline: none; font-family: 'JetBrains Mono'; font-size: 12px;">
                                </select>
                            <button id="delete-tpl-btn" title="Eliminar Actual" style="background: #1a0505; border: 1px solid #522; color: #f44336; padding: 0 12px; border-radius: 4px; cursor: pointer; font-size: 14px;">üóë</button>
                        </div>
                    </div>

                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 5px;">
                        <span id="form-mode-label" style="font-size: 10px; font-weight: bold; color: #666; letter-spacing: 1px;">NUEVA PLANTILLA</span>
                        <button id="cancel-edit-btn" class="hidden" style="background:none; border:none; color:#888; font-size:10px; cursor:pointer; text-decoration:underline;">CANCELAR EDICI√ìN</button>
                    </div>

                    <div style="flex: 1; display: flex; flex-direction: column; gap: 10px;">
                        <input type="text" id="new-tpl-label" placeholder="Nombre de la Plantilla (Ej: SQL Fix)" style="background: #08080a; border: 1px solid #333; color: var(--accent); padding: 10px; border-radius: 4px; outline: none; font-family: inherit;">
                        
                        <textarea id="new-tpl-value" placeholder="Escribe el contenido del prompt aqu√≠..." style="flex: 1; background: #08080a; border: 1px solid #333; color: #ccc; padding: 12px; border-radius: 4px; outline: none; font-family: inherit; resize: none; line-height: 1.5;"></textarea>
                        
                        <div style="display: flex; gap: 10px;">
                            <button id="add-tpl-btn" style="flex: 2; background: #222; color: #fff; border: 1px solid #444; padding: 10px; cursor: pointer; border-radius: 4px; font-weight: bold;">GUARDAR</button>
                            <button id="clone-tpl-btn" class="hidden" style="flex: 1; background: #0d1a20; color: var(--accent); border: 1px solid #004d40; padding: 10px; cursor: pointer; border-radius: 4px; font-size: 10px;">GUARDAR COMO NUEVA</button>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button id="save-settings-btn">CERRAR Y GUARDAR</button>
                </div>
            </div>
        </div>

        <div id="content-wrapper">
            <button id="close-btn" onclick="minimizeApp()">√ó</button>
            
            <div id="login-screen" class="hidden">
                <h3 style="color:#ff9800; letter-spacing:2px; font-size:12px;">SISTEMA PROTEGIDO</h3>
                <input type="password" id="master-key-input" placeholder="CLAVE DE ACCESO">
                <button id="unlock-btn">INICIAR</button>
            </div>

            <div id="main-interface" class="hidden">

                <div id="left-panel">
                    <div id="result-section">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px;">
                            <span class="section-label">Prompt Resultante</span>
                            <div id="toolbar-container">
                                <button id="export-md-btn">>>MD</button>
                            </div>
                        </div>
                        <div id="active-response-area">
                            <div style="text-align:center; color:#444; margin-top:20vh;">
                                <span style="font-size:14px; color:var(--accent);">‚ùñ rm-IAPromper <span id="version"></span></span>
                                <div style="font-size:11px;">Listo para generar prompts estructurados...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="right-panel">
                    
                    <div id="headers-section">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px;">
                            <span class="section-label">Contexto y Esperado</span>
                            <div id="toolbar-container">
                                <button id="templates-list-btn" title="Lista de Plantillas">//</button>
                                <button id="prev-template-btn" title="Plantilla Anterior"><</button>
                                <button id="next-template-btn" title="Siguiente Plantilla">></button>
                                <button id="edit-template-btn" title="Editar Plantilla">‚úé</button>
                                <button id="duplicate-template-btn" title="Duplicar Plantilla">‚ùê</button>
                            </div>
                        </div>
                        <div style="position: relative; height: 100%; display: flex; flex-direction: column;">
                            <textarea id="header-input" readonly placeholder="Selecciona una plantilla de contexto para tu prompt..."></textarea>
                            <div id="template-selector-menu" class="hidden"></div>
                            <div id="autocomplete-menu"></div>
                        </div>
                    </div>

                    <div id="composer-section">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px;">
                            <span class="section-label">Solicitud</span>
                            <div id="toolbar-container">
                                <button id="clear-btn">LIMPIAR</button>
                            </div>
                        </div>

                        <textarea id="ai-input" placeholder="Describe tu solicitud espec√≠fica que quieres que la IA ejecute..."></textarea>

                        <button id="send-btn">GENERAR PROMPT</button>
                    </div>

                </div>
            </div>
        </div>

        <div id="header-hex">
            <svg viewBox="0 0 100 100">
                <path class="hex-outer" d="M50 10 L85 30 L85 70 L50 90 L15 70 L15 30 Z" />
                <path class="hex-inner" d="M50 25 L72 37 L72 63 L50 75 L28 63 L28 37 Z" />
                <circle class="hex-core" cx="50" cy="50" r="12" />
            </svg>
        </div>
    </div>

    <script>
        const { ipcRenderer, clipboard } = require('electron');
        const fs = require('fs');
        const path = require('path');
        
        if (typeof marked !== 'undefined') marked.use({ breaks: true, gfm: true });

        const API_URL = 'http://localhost:5000/api';
        
        let isProcessing = false;

        const DEFAULT_TEMPLATES = [
            { label: 'Mejora de Prompt', value: 'Act√∫a como experto en ingenier√≠a de prompts. Mejora y optimiza el siguiente prompt para obtener mejores resultados de una IA:' },
            { label: 'Generaci√≥n Estructurada', value: 'Genera un prompt estructurado y detallado para que una IA complete la siguiente tarea de manera √≥ptima:' },
            { label: 'Prompt para C√≥digo', value: 'Crea un prompt especializado para generar c√≥digo de alta calidad. Incluye especificaciones t√©cnicas, mejores pr√°cticas y ejemplos:' },
            { label: 'An√°lisis y Explicaci√≥n', value: 'Dise√±a un prompt para an√°lisis t√©cnico detallado que incluya contexto, metodolog√≠a y formato de respuesta esperado:' }
        ];

        // --- CARGA DE DATOS ---
        let headerTemplates = [];
        
        // Funci√≥n para cargar plantillas desde la API
        async function loadTemplates() {
            try {
                const response = await fetch(`${API_URL}/get_templates`);
                const data = await response.json();
                
                if (data.success && data.templates) {
                    return data.templates;
                } else {
                    console.error("Error en respuesta de API:", data.message);
                    return [...DEFAULT_TEMPLATES];
                }
            } catch (err) {
                console.error("Error cargando templates desde API:", err);
                return [...DEFAULT_TEMPLATES];
            }
        }
        
        // Funci√≥n para guardar plantillas en la API
        async function saveTemplates(templates) {
            try {
                const response = await fetch(`${API_URL}/save_templates`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({templates})
                });
                const data = await response.json();
                return data.success;
            } catch (err) {
                console.error("Error guardando templates:", err);
                return false;
            }
        }
        
        // Las plantillas se cargar√°n despu√©s del login exitoso

        let editingIndex = -1;
        
        // Sistema de navegaci√≥n de plantillas (Nuevo)
        let currentTemplateIndex = -1;
        let isEditing = false;
        let hasUnsavedChanges = false;

        // UI REFERENCES
        const ui = {
            responseArea: document.getElementById('active-response-area'),
            headerInput: document.getElementById('header-input'),
            bodyInput: document.getElementById('ai-input'),
            autocompleteMenu: document.getElementById('autocomplete-menu'),
            sendBtn: document.getElementById('send-btn'),
            hexContainer: document.getElementById('header-hex'),
            login: document.getElementById('login-screen'),
            main: document.getElementById('main-interface'),
            
            // Export buttons
            exportMdBtn: document.getElementById('export-md-btn'),
            exportTxtBtn: document.getElementById('export-txt-btn'),
            exportStatus: document.getElementById('export-status'),
            
            // Nueva barra de herramientas
            templatesListBtn: document.getElementById('templates-list-btn'),
            prevTemplateBtn: document.getElementById('prev-template-btn'),
            nextTemplateBtn: document.getElementById('next-template-btn'),
            editTemplateBtn: document.getElementById('edit-template-btn'),
            duplicateTemplateBtn: document.getElementById('duplicate-template-btn'),
            templateSelectorMenu: document.getElementById('template-selector-menu'),
            
            // Modal Elements (Para compatibilidad temporal)
            modal: document.getElementById('settings-modal'),
            tplSelector: document.getElementById('tpl-selector'),
            deleteBtn: document.getElementById('delete-tpl-btn'),
            
            settingsBtn: document.getElementById('settings-trigger-btn'),
            closeSettingsBtn: document.getElementById('close-settings-btn'),
            saveSettingsBtn: document.getElementById('save-settings-btn'),
            
            addTplBtn: document.getElementById('add-tpl-btn'),
            cloneTplBtn: document.getElementById('clone-tpl-btn'),
            newLabel: document.getElementById('new-tpl-label'),
            newValue: document.getElementById('new-tpl-value'),
            
            formModeLabel: document.getElementById('form-mode-label'),
            cancelEditBtn: document.getElementById('cancel-edit-btn')
        };

        // --- NUEVO SISTEMA DE NAVEGACI√ìN DE PLANTILLAS ---
        
        // Inicializar con la primera plantilla al cargar
        async function initializeTemplates() {
            headerTemplates = await loadTemplates();
            console.log('Plantillas cargadas:', headerTemplates.length);
            if (headerTemplates.length > 0) {
                currentTemplateIndex = 0;
                loadCurrentTemplate();
                console.log('Plantilla inicial cargada:', headerTemplates[0].label);
            }
        }
        
        function loadCurrentTemplate() {
            if (currentTemplateIndex >= 0 && currentTemplateIndex < headerTemplates.length) {
                const template = headerTemplates[currentTemplateIndex];
                ui.headerInput.value = template.value;
                updateTemplateSelectorMenu();
            }
        }
        
        function updateTemplateSelectorMenu() {
            ui.templateSelectorMenu.innerHTML = '';
            
            headerTemplates.forEach((tpl, index) => {
                const div = document.createElement('div');
                div.className = 'template-menu-item';
                if (index === currentTemplateIndex) {
                    div.classList.add('current');
                }
                div.innerHTML = `
                    <strong>${tpl.label}</strong>
                    <div class="template-preview">${tpl.value.substring(0, 50)}...</div>
                `;
                div.onclick = () => selectTemplateByIndex(index);
                ui.templateSelectorMenu.appendChild(div);
            });
        }
        
        function showTemplateSelector() {
            updateTemplateSelectorMenu();
            ui.templateSelectorMenu.classList.remove('hidden');
        }
        
        function hideTemplateSelector() {
            ui.templateSelectorMenu.classList.add('hidden');
        }
        
        function selectTemplateByIndex(index) {
            if (index >= 0 && index < headerTemplates.length) {
                currentTemplateIndex = index;
                loadCurrentTemplate();
                ui.headerInput.readOnly = !isEditing;
                hideTemplateSelector();
                console.log('Plantilla seleccionada por √≠ndice:', index);
            }
        }
        
        function navigateTemplate(direction) {
            if (headerTemplates.length === 0) return;
            
            // En el nuevo sistema, no verificamos cambios sin guardar antes de navegar
            // ya que el guardado es inmediato al salir del modo edici√≥n
            
            currentTemplateIndex += direction;
            if (currentTemplateIndex < 0) currentTemplateIndex = headerTemplates.length - 1;
            if (currentTemplateIndex >= headerTemplates.length) currentTemplateIndex = 0;
            
            loadCurrentTemplate();
            ui.headerInput.readOnly = !isEditing;
            console.log('Navegando plantilla:', direction > 0 ? 'siguiente' : 'anterior');
        }
        
        function toggleEditMode() {
            if (isEditing) {
                // ESTAMOS EN MODO EDICI√ìN - GUARDAR Y SALIR
                console.log('Click en modo edici√≥n - Guardando...');
                saveCurrentTemplate().then(success => {
                    if (success) {
                        deactivateEditMode();
                        console.log('Guardado exitoso - Modo edici√≥n desactivado');
                    } else {
                        console.log('Error al guardar - Manteniendo modo edici√≥n');
                        // Mantener modo edici√≥n si falla el guardado
                    }
                });
            } else {
                // ESTAMOS EN MODO LECTURA - ACTIVAR EDICI√ìN
                console.log('Click en modo lectura - Activando edici√≥n...');
                activateEditMode();
                console.log('Modo edici√≥n activado');
            }
        }
        
        function activateEditMode() {
            isEditing = true;
            
            // Configurar textarea para edici√≥n
            ui.headerInput.readOnly = false;
            ui.headerInput.classList.add('editing-mode');
            
            // Cambiar bot√≥n de edici√≥n a guardado
            ui.editTemplateBtn.textContent = 'üíæ';
            ui.editTemplateBtn.title = 'Guardar Cambios';
            
            // DESHABILITAR ELEMENTOS QUE CAMBIAN CONTEXTO/PLANTILLA
            const contextChangeButtons = [
                ui.templatesListBtn,      // Lista de plantillas
                ui.prevTemplateBtn,        // Navegaci√≥n anterior
                ui.nextTemplateBtn,        // Navegaci√≥n siguiente
                ui.duplicateTemplateBtn    // Duplicar plantilla
            ];
            
            // Deshabilitar todos los botones de cambio de contexto
            contextChangeButtons.forEach(btn => {
                if (btn) {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                }
            });
            
            // Enfocar y seleccionar contenido
            ui.headerInput.focus();
            ui.headerInput.select();
            
            console.log('Modo edici√≥n activado - Cambios de contexto deshabilitados');
        }
        
        function deactivateEditMode() {
            isEditing = false;
            
            // Restaurar textarea a solo lectura
            ui.headerInput.readOnly = true;
            ui.headerInput.classList.remove('editing-mode');
            
            // Cambiar bot√≥n de guardado a edici√≥n
            ui.editTemplateBtn.textContent = '‚úé';
            ui.editTemplateBtn.title = 'Editar Plantilla';
            
            // REACTIVAR TODOS LOS ELEMENTOS PREVIAMENTE DESHABILITADOS
            const contextChangeButtons = [
                ui.templatesListBtn,      
                ui.prevTemplateBtn,        
                ui.nextTemplateBtn,        
                ui.duplicateTemplateBtn    
            ];
            
            contextChangeButtons.forEach(btn => {
                if (btn) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                }
            });
            

            
            console.log('Modo edici√≥n desactivado - Todos los controles reactivados');
        }
        
        function duplicateCurrentTemplate() {
            if (currentTemplateIndex >= 0 && currentTemplateIndex < headerTemplates.length) {
                const currentTemplate = headerTemplates[currentTemplateIndex];
                const newTemplate = {
                    label: currentTemplate.label + ' (Copia)',
                    value: currentTemplate.value
                };
                headerTemplates.push(newTemplate);
                currentTemplateIndex = headerTemplates.length - 1;
                loadCurrentTemplate();
                console.log('Plantilla duplicada creada');
            }
        }
        
        function updateUnsavedState(changed) {
            hasUnsavedChanges = changed;
            // Ya no hay bot√≥n de save separado, el estado se maneja por el toggle button
            console.log('Estado de cambios sin guardar:', changed);
        }
        
        async function saveCurrentTemplate() {
            if (currentTemplateIndex >= 0 && currentTemplateIndex < headerTemplates.length) {
                const newValue = ui.headerInput.value.trim();
                if (!newValue) {
                    alert('El contenido de la plantilla no puede estar vac√≠o.');
                    return false;
                }
                
                headerTemplates[currentTemplateIndex].value = newValue;
                
                const success = await saveTemplates(headerTemplates);
                if (success) {
                    console.log('Plantilla guardada exitosamente');
                    return true;
                } else {
                    alert('Error al guardar la plantilla. Intenta nuevamente.');
                    return false;
                }
            }
            return false;
        }
        
        // Event listeners para la nueva barra de herramientas
        ui.templatesListBtn.addEventListener('click', () => {
            if (!isEditing && ui.templateSelectorMenu.classList.contains('hidden')) {
                showTemplateSelector();
            } else if (!isEditing) {
                hideTemplateSelector();
            }
        });
        
        ui.prevTemplateBtn.addEventListener('click', () => {
            if (!isEditing) {
                navigateTemplate(-1);
            }
        });
        
        ui.nextTemplateBtn.addEventListener('click', () => {
            if (!isEditing) {
                navigateTemplate(1);
            }
        });
        
        // EL MISMO BOT√ìN FUNCIONA COMO EDIT/SAVE (TOGGLE)
        ui.editTemplateBtn.addEventListener('click', toggleEditMode);
        
        ui.duplicateTemplateBtn.addEventListener('click', () => {
            if (!isEditing) {
                duplicateCurrentTemplate();
            }
        });
        

        
        // Detectar cambios en el textarea (solo para feedback visual durante edici√≥n)
        ui.headerInput.addEventListener('input', () => {
            if (isEditing) {
                // Feedback visual de cambios (sin estado separate de "unsaved")
                console.log('Cambios detectados en modo edici√≥n');
            }
        });
        
        // Permitir salir del modo edici√≥n con Escape
        ui.headerInput.addEventListener('keydown', (e) => {
            if (isEditing && e.key === 'Escape') {
                toggleEditMode();
            }
        });
        
        // Cerrar men√∫s al hacer clic fuera
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#headers-section')) {
                hideTemplateSelector();
            }
        });

        // --- AUTOCOMPLETE & CORE (Actualizado) ---
        function setHexState(state) { ui.hexContainer.className = state ? `status-${state}` : ''; }

        let selectedIndex = -1;
        ui.headerInput.addEventListener('input', (e) => {
            if (e.target.value.includes('//') && !isEditing) {
                showAutocomplete();
            } else {
                hideAutocomplete();
            }
        });

        function showAutocomplete() {
            ui.autocompleteMenu.innerHTML = '';
            headerTemplates.forEach((tpl, index) => {
                const div = document.createElement('div');
                div.className = 'autocomplete-item';
                div.innerHTML = `<strong>${tpl.label}</strong><span style="opacity:0.6">${tpl.value.substring(0, 40)}...</span>`;
                div.onclick = () => selectTemplateFromAutocomplete(index);
                ui.autocompleteMenu.appendChild(div);
            });
            ui.autocompleteMenu.style.display = 'block';
        }

        function hideAutocomplete() { ui.autocompleteMenu.style.display = 'none'; selectedIndex = -1; }

        function selectTemplateFromAutocomplete(templateIndex) {
            currentTemplateIndex = templateIndex;
            loadCurrentTemplate();
            hideAutocomplete();
            ui.bodyInput.focus();
        }

        ui.headerInput.addEventListener('keydown', (e) => {
            if (ui.autocompleteMenu.style.display === 'block') {
                const items = document.querySelectorAll('.autocomplete-item');
                if (e.key === 'ArrowDown') { e.preventDefault(); selectedIndex = (selectedIndex + 1) % items.length; highlightItem(items); }
                else if (e.key === 'ArrowUp') { e.preventDefault(); selectedIndex = (selectedIndex - 1 + items.length) % items.length; highlightItem(items); }
                else if (e.key === 'Enter') { e.preventDefault(); if (selectedIndex >= 0) selectTemplateFromAutocomplete(selectedIndex); }
                else if (e.key === 'Escape') hideAutocomplete();
            }
        });

        function highlightItem(items) {
            items.forEach(i => i.classList.remove('selected'));
            if(items[selectedIndex]) items[selectedIndex].classList.add('selected');
        }

        async function sendAI() {
            if (isProcessing) return;
            const fullQuery = (ui.headerInput.value.trim() ? ui.headerInput.value.trim() + "\n\n" : "") + ui.bodyInput.value.trim();
            if (!fullQuery.trim()) return;

            isProcessing = true;
            setHexState('thinking');
            ui.responseArea.innerHTML = `<div style="text-align:center; opacity:0.7; margin-top:50px; color:var(--accent);">GENERANDO PROMPT OPTIMIZADO...</div>`;

            try {
                const res = await fetch(`${API_URL}/query_gemini`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({query: fullQuery})
                });
                const data = await res.json();
                if (data.response) { renderResponse(data.response); setHexState('success'); }
                else { renderError(data.error); setHexState('error'); }
            } catch (e) { renderError("Error de conexi√≥n."); setHexState('error'); }

            isProcessing = false;
            setTimeout(() => setHexState(''), 3000);
        }

        function renderResponse(txt) {
            ui.responseArea.innerHTML = `<div class="response-content">${marked.parse(txt)}</div>`;
            ui.responseArea.querySelectorAll('pre code').forEach((block) => hljs.highlightElement(block));
            addCopyButtons();
        }

        function addCopyButtons() {
            ui.responseArea.querySelectorAll('pre').forEach((preBlock) => {
                if(preBlock.querySelector('button')) return;
                const btn = document.createElement('button');
                btn.textContent = 'COPIAR';
                btn.style.cssText = "position:absolute; top:10px; right:10px; background:#222; color:var(--accent); border:1px solid #444; padding:4px 8px; font-size:9px; cursor:pointer; border-radius:3px; opacity:0.8;";
                preBlock.style.position = 'relative';
                btn.addEventListener('click', () => {
                    clipboard.writeText(preBlock.querySelector('code').innerText);
                    btn.textContent = 'COPIADO'; setTimeout(()=> btn.textContent='COPIAR', 2000);
                });
                preBlock.appendChild(btn);
            });
        }

        function renderError(msg) { ui.responseArea.innerHTML = `<div style="color:#f44336; padding:20px;">ERROR: ${msg}</div>`; }

        ui.sendBtn.addEventListener('click', sendAI);
        ui.bodyInput.addEventListener('keydown', (e) => { if (e.ctrlKey && e.key === 'Enter') sendAI(); });
        document.getElementById('clear-btn').addEventListener('click', () => { ui.headerInput.value = ''; ui.bodyInput.value = ''; });

        window.minimizeApp = function() { ipcRenderer.send('resize-window', 'mini'); }
        
        ui.hexContainer.addEventListener('click', () => {
            const isMini = document.body.classList.contains('mode-mini');
            // FIX CR√çTICO: Asegura que el estado se env√≠e correctamente al Main
            ipcRenderer.send('resize-window', isMini ? 'expanded' : 'mini');
        });
        
        ipcRenderer.on('force-mode-update', (e, mode) => {
            document.body.className = `mode-${mode}`;
        });

        // LOCK SYSTEM
        const attemptUnlock = async () => {
            const key = document.getElementById('master-key-input').value;
            setHexState('thinking');
            try {
                const res = await fetch(`${API_URL}/initialize`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({master_key: key}) });
                const d = await res.json();
                if(d.success) { 
                    ui.login.classList.add('hidden'); 
                    ui.main.classList.remove('hidden'); 
                    setHexState('success');
                    // Inicializar plantillas despu√©s del login exitoso
                    await initializeTemplates();
                }
                else { setHexState('error'); }
            } catch(e) { setHexState('error'); }
        };

        (async () => {
            try {
                const res = await fetch(`${API_URL}/is_initialized`);
                const data = await res.json();
                if(data.initialized) { 
                    ui.login.classList.add('hidden'); 
                    ui.main.classList.remove('hidden');
                    // Inicializar plantillas si ya est√° autenticado
                    await initializeTemplates();
                }
                else ui.login.classList.remove('hidden');
            } catch(e) {}
        })();
        
        document.getElementById('unlock-btn').addEventListener('click', attemptUnlock);
        document.getElementById('master-key-input').addEventListener('keypress', (e) => e.key === 'Enter' && attemptUnlock());
        
        // --- FUNCIONES DE EXPORTACI√ìN ---
        
        // Funci√≥n para mostrar estado de exportaci√≥n
        function mostrarEstadoExportacion(mensaje, esExito = true) {
            ui.exportStatus.textContent = mensaje;
            ui.exportStatus.style.color = esExito ? '#27ae60' : '#e74c3c';
            
            setTimeout(() => {
                ui.exportStatus.textContent = '';
                ui.exportStatus.style.color = '#666';
            }, 3000);
        }
        
        // Funci√≥n para extraer contenido del panel de resultados
        function extraerContenidoPanel() {
            const responseContent = ui.responseArea.querySelector('.response-content');
            if (!responseContent) {
                return null;
            }
            
            // Convertir HTML a texto plano manteniendo estructura Markdown
            let contenido = responseContent.innerHTML;
            
            // Procesar c√≥digo con sintaxis highlight
            const codeBlocks = responseContent.querySelectorAll('pre code');
            codeBlocks.forEach((codeBlock, index) => {
                const language = codeBlock.className.match(/language-(\w+)/)?.[1] || '';
                const code = codeBlock.textContent;
                contenido = contenido.replace(codeBlock.outerHTML, `\n\`\`\`${language}\n${code}\n\`\`\`\n`);
            });
            
            // Procesar t√≠tulos y texto
            contenido = contenido
                .replace(/<h1[^>]*>(.*?)<\/h1>/gi, '# $1\n')
                .replace(/<h2[^>]*>(.*?)<\/h2>/gi, '## $1\n')
                .replace(/<h3[^>]*>(.*?)<\/h3>/gi, '### $1\n')
                .replace(/<h4[^>]*>(.*?)<\/h4>/gi, '#### $1\n')
                .replace(/<h5[^>]*>(.*?)<\/h5>/gi, '##### $1\n')
                .replace(/<h6[^>]*>(.*?)<\/h6>/gi, '###### $1\n')
                .replace(/<strong[^>]*>(.*?)<\/strong>/gi, '**$1**')
                .replace(/<b[^>]*>(.*?)<\/b>/gi, '**$1**')
                .replace(/<em[^>]*>(.*?)<\/em>/gi, '*$1*')
                .replace(/<i[^>]*>(.*?)<\/i>/gi, '*$1*')
                .replace(/<li[^>]*>(.*?)<\/li>/gi, '- $1\n')
                .replace(/<p[^>]*>(.*?)<\/p>/gi, '$1\n\n')
                .replace(/<br\s*\/?>/gi, '\n')
                .replace(/<[^>]*>/g, '') // Eliminar etiquetas HTML restantes
                .replace(/\n{3,}/g, '\n\n') // Normalizar l√≠neas m√∫ltiples
                .trim();
            
            return contenido;
        }
        
        // Funci√≥n para generar nombre de archivo con timestamp
        function generarNombreArchivo(extension) {
            const ahora = new Date();
            const timestamp = ahora.toISOString().slice(0, 19).replace(/[:-]/g, '').replace('T', '-');
            return `prompt-export-${timestamp}.${extension}`;
        }
        
        // Funci√≥n para verificar si hay contenido para exportar
        function tieneContenidoExportable() {
            const responseContent = ui.responseArea.querySelector('.response-content');
            if (!responseContent) return false;
            
            const texto = responseContent.textContent.trim();
            return texto.length > 0 && !texto.includes('‚ùñ rm-IAPromper ONLINE');
        }
        
        // Funci√≥n para exportar a Markdown
        async function exportarAMarkdown() {
            try {
                if (!tieneContenidoExportable()) {
                    mostrarEstadoExportacion('‚ö†Ô∏è Genera un prompt primero', false);
                    return;
                }
                
                const contenido = extraerContenidoPanel();
                if (!contenido) {
                    mostrarEstadoExportacion('‚ùå No se pudo extraer contenido', false);
                    return;
                }
                
                const nombreArchivo = generarNombreArchivo('md');
                
                // Solicitar al proceso principal que guarde el archivo
                ipcRenderer.invoke('save-file', {
                    nombreArchivo: nombreArchivo,
                    contenido: contenido,
                    tipoArchivo: 'markdown'
                }).then(resultado => {
                    if (resultado.exito) {
                        mostrarEstadoExportacion(`‚úÖ ${nombreArchivo}`);
                    } else {
                        mostrarEstadoExportacion(`‚ùå ${resultado.error}`, false);
                    }
                }).catch(error => {
                    console.error('Error al exportar:', error);
                    mostrarEstadoExportacion('‚ùå Error de exportaci√≥n', false);
                });
                
            } catch (error) {
                console.error('Error en exportaci√≥n MD:', error);
                mostrarEstadoExportacion('‚ùå Error inesperado', false);
            }
        }
        
        // Funci√≥n para exportar a Texto Plano
        async function exportarATexto() {
            try {
                if (!tieneContenidoExportable()) {
                    mostrarEstadoExportacion('‚ö†Ô∏è Genera un prompt primero', false);
                    return;
                }
                
                const contenido = extraerContenidoPanel();
                if (!contenido) {
                    mostrarEstadoExportacion('‚ùå No se pudo extraer contenido', false);
                    return;
                }
                
                const nombreArchivo = generarNombreArchivo('txt');
                
                // Convertir Markdown a texto plano
                const contenidoTexto = contenido
                    .replace(/#{1,6}\s+/g, '') // Quitar encabezados
                    .replace(/\*\*(.*?)\*\*/g, '$1') // Quitar negrita
                    .replace(/\*(.*?)\*/g, '$1') // Quitar cursiva
                    .replace(/```[\w]*\n?/g, '') // Quitar bloques de c√≥digo
                    .replace(/`([^`]+)`/g, '$1') // Quitar c√≥digo inline
                    .replace(/^\s*[-*+]\s+/gm, '‚Ä¢ ') // Convertir listas a vi√±etas
                    .replace(/\n{3,}/g, '\n\n') // Normalizar l√≠neas
                    .trim();
                
                ipcRenderer.invoke('save-file', {
                    nombreArchivo: nombreArchivo,
                    contenido: contenidoTexto,
                    tipoArchivo: 'texto'
                }).then(resultado => {
                    if (resultado.exito) {
                        mostrarEstadoExportacion(`‚úÖ ${nombreArchivo}`);
                    } else {
                        mostrarEstadoExportacion(`‚ùå ${resultado.error}`, false);
                    }
                }).catch(error => {
                    console.error('Error al exportar:', error);
                    mostrarEstadoExportacion('‚ùå Error de exportaci√≥n', false);
                });
                
            } catch (error) {
                console.error('Error en exportaci√≥n TXT:', error);
                mostrarEstadoExportacion('‚ùå Error inesperado', false);
            }
        }
        
        // Event listeners para botones de exportaci√≥n
        ui.exportMdBtn.addEventListener('click', exportarAMarkdown);
        ui.exportTxtBtn.addEventListener('click', exportarATexto);

        document.getElementById('version').textContent = window.AppVersion.APP_VERSION;
    </script>
</body>
</html>